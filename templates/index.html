<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµé‡æ¶ˆè€—å™¨ ğŸ€</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #e91e63;
            --secondary-color: #f06292;
            --background-color: #fce4ec;
            --card-bg-color: rgba(255, 255, 255, 0.85);
            --text-color: #333;
            --border-color: #f8bbd0;
        }
        body {
            background-color: var(--background-color);
            font-family: 'Noto Sans SC', sans-serif;
            padding-top: 1.5rem;
        }
        .card {
            margin-bottom: 1.5rem;
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-radius: 0.75rem;
        }
        .card-header {
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--primary-color);
            font-weight: bold;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        .badge.bg-success {
            background-color: var(--primary-color) !important;
        }
        .form-control, .form-select {
            border-color: var(--border-color);
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(233, 30, 99, 0.25);
        }
        h1 {
            color: var(--primary-color);
            font-weight: 700;
        }
        .nav-tabs .nav-link {
            color: var(--secondary-color);
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--card-bg-color);
            border-color: var(--border-color) var(--border-color) var(--card-bg-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4" data-aos="fade-down">
            <h1><i class="bi bi-gem"></i> æµé‡æ¶ˆè€—å™¨ - ç”œå¿ƒç‰ˆ</h1>
        </div>

        <div class="row">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="col-lg-4">
                <div class="card" data-aos="fade-right">
                    <div class="card-header"><i class="bi bi-speedometer2"></i> æ ¸å¿ƒä»ªè¡¨ç›˜</div>
                    <div class="card-body">
                        <h5>çŠ¶æ€: <span id="running-status" class="badge bg-secondary">å·²åœæ­¢</span></h5>
                        <hr>
                        <p class="mb-1"><strong>å®æ—¶é€Ÿåº¦:</strong> <span id="speed-text" class="fw-bold text-primary">0 B/s</span></p>
                        <p class="mb-1"><strong>æ€»æ¶ˆè€—:</strong> <span id="total-bytes">0 B</span></p>
                        <p class="mb-1"><strong>ä¸‹è½½æ•°:</strong> <span id="download-count">0</span></p>
                        <p class="mb-3"><strong>é…ç½®:</strong> <span id="current-config">N/A</span></p>
                        <div class="input-group mb-3">
                            <label class="input-group-text" for="config-select"><i class="bi bi-file-earmark-text"></i></label>
                            <select class="form-select" id="config-select"></select>
                        </div>
                        <div class="d-grid gap-2">
                            <button id="start-btn" class="btn btn-primary"><i class="bi bi-play-fill"></i> å¯åŠ¨</button>
                            <button id="stop-btn" class="btn btn-danger" disabled><i class="bi bi-stop-fill"></i> åœæ­¢</button>
                            <button id="stop-scheduler-btn" class="btn btn-warning" disabled><i class="bi bi-calendar-x"></i> åœæ­¢è®¡åˆ’</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ä¿¡æ¯åŒº -->
            <div class="col-lg-8">
                <div class="card" data-aos="fade-left">
                    <div class="card-header"><i class="bi bi-graph-up-arrow"></i> å®æ—¶é€Ÿåº¦</div>
                    <div class="card-body" style="height: 200px;">
                        <canvas id="speed-chart"></canvas>
                    </div>
                </div>

                <div class="card" data-aos="fade-up" data-aos-delay="100">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="info-tab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="scheduler-tab" data-bs-toggle="tab" data-bs-target="#scheduler-panel" type="button" role="tab"><i class="bi bi-calendar-heart"></i> è°ƒåº¦ä¸å†å²</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-panel" type="button" role="tab"><i class="bi bi-pencil-square"></i> é…ç½®ç¼–è¾‘å™¨</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body tab-content" id="info-tab-content">
                        <!-- è°ƒåº¦ä¸å†å²é¢æ¿ -->
                        <div class="tab-pane fade show active" id="scheduler-panel" role="tabpanel">
                            <p><strong>å½“å‰ä»»åŠ¡:</strong> <span id="job-details" class="fw-bold">æ— </span></p>
                            <p><strong>ä¸‹æ¬¡è¿è¡Œ:</strong> <span id="next-run-time" class="fw-bold">æ— </span> | <strong>å€’è®¡æ—¶:</strong> <span id="countdown" class="fw-bold">æ— </span></p>
                            <h6 class="card-subtitle mb-2 text-muted mt-3">æ‰§è¡Œå†å²</h6>
                            <div style="height: 180px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead><tr><th>æ—¶é—´</th><th>ç»“æœ</th><th>æµé‡</th></tr></thead>
                                    <tbody id="history-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- é…ç½®ç¼–è¾‘å™¨é¢æ¿ -->
                        <div class="tab-pane fade" id="config-panel" role="tabpanel">
                            <div class="mb-2">
                                <label for="config-name" class="form-label">é…ç½®åç§°</label>
                                <input type="text" class="form-control" id="config-name" placeholder="ä¾‹å¦‚: my_pink_task">
                            </div>
                            <div class="mb-2">
                                <label for="urls" class="form-label">URLs (æ¯è¡Œä¸€ä¸ª)</label>
                                <textarea class="form-control" id="urls" rows="2"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-2"><input type="number" class="form-control" id="threads" placeholder="çº¿ç¨‹æ•°"></div>
                                <div class="col-6 mb-2"><input type="number" class="form-control" id="limit-speed" placeholder="é™é€Ÿ(MB/s)"></div>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-2"><input type="number" class="form-control" id="traffic-limit" placeholder="æµé‡é™åˆ¶(MB)"></div>
                                <div class="col-6 mb-2"><input type="number" class="form-control" id="duration" placeholder="æ—¶é•¿(ç§’)"></div>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-2"><input type="number" class="form-control" id="count" placeholder="ä¸‹è½½æ¬¡æ•°"></div>
                                <div class="col-6 mb-2"><input type="number" class="form-control" id="interval" placeholder="é—´éš”(åˆ†é’Ÿ)"></div>
                            </div>
                            <div class="mb-2">
                                <input type="text" class="form-control" id="cron-expr" placeholder="Cronè¡¨è¾¾å¼">
                            </div>
                            <div class="d-grid">
                                <button id="save-config-btn" class="btn btn-success"><i class="bi bi-save"></i> ä¿å­˜é…ç½®</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({ once: true });

        document.addEventListener('DOMContentLoaded', (event) => {
            const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

            // --- å…ƒç´ è·å– ---
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const stopSchedulerBtn = document.getElementById('stop-scheduler-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const configSelect = document.getElementById('config-select');
            const runningStatus = document.getElementById('running-status');
            const configInputs = {
                name: document.getElementById('config-name'),
                urls: document.getElementById('urls'),
                threads: document.getElementById('threads'),
                limit_speed: document.getElementById('limit-speed'),
                traffic_limit: document.getElementById('traffic-limit'),
                duration: document.getElementById('duration'),
                count: document.getElementById('count'),
                cron_expr: document.getElementById('cron-expr'),
                interval: document.getElementById('interval')
            };
            const jobDetailsEl = document.getElementById('job-details');
            const nextRunTimeEl = document.getElementById('next-run-time');
            const countdownEl = document.getElementById('countdown');
            const historyTableBody = document.getElementById('history-table-body');

            // --- Chart.js åˆå§‹åŒ– ---
            const speedChartCtx = document.getElementById('speed-chart').getContext('2d');
            const speedChart = new Chart(speedChartCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'é€Ÿåº¦ (MB/s)',
                        data: [],
                        borderColor: 'rgba(233, 30, 99, 0.8)',
                        backgroundColor: 'rgba(233, 30, 99, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { display: false },
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#6d4c41' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            function addDataToChart(label, data) {
                speedChart.data.labels.push(label);
                speedChart.data.datasets.forEach((dataset) => {
                    dataset.data.push(data);
                });
                if (speedChart.data.labels.length > 30) {
                    speedChart.data.labels.shift();
                    speedChart.data.datasets[0].data.shift();
                }
                speedChart.update('none'); // 'none' for no animation
            }

            // --- Socket.IO äº‹ä»¶å¤„ç† ---
            socket.on('connect', () => {
                console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                socket.emit('get_configs');
            });

            socket.on('configs_list', (data) => {
                configSelect.innerHTML = '';
                data.configs.forEach(config => {
                    const option = document.createElement('option');
                    option.value = config;
                    option.textContent = config;
                    configSelect.appendChild(option);
                });
                if (data.configs.length > 0) {
                    configSelect.dispatchEvent(new Event('change'));
                }
            });

            socket.on('config_details', (data) => {
                configInputs.name.value = data.name;
                configInputs.urls.value = data.config.urls ? data.config.urls.join('\n') : '';
                configInputs.threads.value = data.config.threads || '';
                configInputs.limit_speed.value = data.config.limit_speed !== null ? data.config.limit_speed : '';
                configInputs.traffic_limit.value = data.config.traffic_limit || '';
                configInputs.duration.value = data.config.duration || '';
                configInputs.count.value = data.config.count || '';
                configInputs.cron_expr.value = data.config.cron_expr || '';
                configInputs.interval.value = data.config.interval || '';
            });

            socket.on('status_update', (data) => {
                if (data.running) {
                    runningStatus.textContent = 'è¿è¡Œä¸­';
                    runningStatus.className = 'badge bg-success';
                } else {
                    runningStatus.textContent = 'å·²åœæ­¢';
                    runningStatus.className = 'badge bg-secondary';
                }
                document.getElementById('speed-text').textContent = data.speed || '0 B/s';
                document.getElementById('total-bytes').textContent = data.total_bytes || '0 B';
                document.getElementById('download-count').textContent = data.download_count || '0';
                document.getElementById('current-config').textContent = data.config || 'N/A';

                const speedValue = data.speed ? data.speed.match(/(\d+\.\d+)\s*MB\/s/i) : null;
                const speedMB = speedValue ? parseFloat(speedValue[1]) : 0;
                addDataToChart(new Date().toLocaleTimeString(), speedMB);

                startBtn.disabled = data.running;
                stopBtn.disabled = !data.running;
            });

            socket.on('history_update', (record) => {
                const row = historyTableBody.insertRow(0);
                row.innerHTML = `<td>${new Date(record.timestamp).toLocaleString()}</td><td>${record.result}</td><td>${record.bytes_consumed}</td>`;
                const noHistoryRow = historyTableBody.querySelector('.no-history');
                if (noHistoryRow) noHistoryRow.remove();
                while (historyTableBody.rows.length > 50) {
                    historyTableBody.deleteRow(historyTableBody.rows.length - 1);
                }
            });

            socket.on('request_status_update', updateSchedulerStatus);

            // --- è°ƒåº¦å™¨çŠ¶æ€æ›´æ–° ---
            let countdownInterval;
            function updateSchedulerStatus() {
                fetch('/api/scheduler_status')
                    .then(response => response.json())
                    .then(data => {
                        jobDetailsEl.textContent = data.job_details || 'æ— ';
                        stopSchedulerBtn.disabled = !data.job_details;

                        if (data.next_run_time) {
                            const nextRunDate = new Date(data.next_run_time);
                            nextRunTimeEl.textContent = nextRunDate.toLocaleString();
                            if (countdownInterval) clearInterval(countdownInterval);
                            countdownInterval = setInterval(() => {
                                const diff = nextRunDate - new Date();
                                if (diff <= 0) {
                                    countdownEl.textContent = 'è¿è¡Œä¸­...';
                                    clearInterval(countdownInterval);
                                    setTimeout(updateSchedulerStatus, 2000);
                                    return;
                                }
                                const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                                const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                                const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                                countdownEl.textContent = `${h}:${m}:${s}`;
                            }, 1000);
                        } else {
                            nextRunTimeEl.textContent = 'æ— ';
                            countdownEl.textContent = 'æ— ';
                            if (countdownInterval) clearInterval(countdownInterval);
                        }

                        historyTableBody.innerHTML = '';
                        if (data.history && data.history.length > 0) {
                            data.history.forEach(item => {
                                const row = historyTableBody.insertRow();
                                row.innerHTML = `<td>${new Date(item.timestamp).toLocaleString()}</td><td>${item.result}</td><td>${item.bytes_consumed}</td>`;
                            });
                        } else {
                            historyTableBody.innerHTML = '<tr class="no-history text-center"><td colspan="3">æš‚æ— å†å²è®°å½•</td></tr>';
                        }
                    })
                    .catch(error => console.error('è·å–è°ƒåº¦å™¨çŠ¶æ€æ—¶å‡ºé”™:', error));
            }
            
            // --- äº‹ä»¶ç›‘å¬ ---
            function getConfigFromForm() {
                const data = {};
                for (const key in configInputs) {
                    data[key] = configInputs[key].value || null;
                }
                data.urls = data.urls ? data.urls.split(/\r?\n/).filter(url => url.trim() !== '') : [];
                ['threads', 'limit_speed', 'traffic_limit', 'duration', 'count', 'interval'].forEach(key => {
                    data[key] = data[key] ? parseInt(data[key], 10) : null;
                });
                return data;
            }

            startBtn.addEventListener('click', () => {
                socket.emit('start_consumer', getConfigFromForm());
                setTimeout(updateSchedulerStatus, 500);
            });

            stopBtn.addEventListener('click', () => {
                socket.emit('stop_consumer');
                setTimeout(updateSchedulerStatus, 500);
            });

            stopSchedulerBtn.addEventListener('click', () => socket.emit('stop_scheduler'));

            saveConfigBtn.addEventListener('click', () => {
                const config = getConfigFromForm();
                socket.emit('save_config', { name: config.name, data: config });
            });

            configSelect.addEventListener('change', () => {
                socket.emit('get_config_details', { name: configSelect.value });
            });

            // --- åˆå§‹åŠ è½½ ---
            updateSchedulerStatus();
            setInterval(updateSchedulerStatus, 30000);
        });
    </script>
</body>
</html>